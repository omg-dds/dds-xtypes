######################################################################
# To compile, type:
# 	make -f makefile_rti_connext_dds_linux
# To compile with the Debug option, use:
#   make -f makefile_rti_connext_dds_linux DEBUG=1
#
# This makefile assumes that your build environment is already correctly
# configured. (For example, the correct version of your compiler and
# linker should be on your PATH.)
#
# You should set the environment variable NDDSHOME to point to where
# RTI Connext DDS is installed.
#
######################################################################

# If undefined in the environment default NDDSHOME to install dir
ifndef NDDSHOME
$(error NDDSHOME not defined)
endif

COMPILER_FLAGS = -m64
LINKER_FLAGS = -m64 -static-libgcc

split_path_name = $(subst /rti_, , $(NDDSHOME))

version_name = $(lastword $(split_path_name))
common_name = "_test_main_linux"
executable_name = $(version_name)$(common_name)

TARGET_ARCH = $(CONNEXTDDS_ARCH)

ifndef COMPILER
COMPILER = g++
endif

ifndef LINKER
LINKER = g++
endif

SYSLIBS = -ldl -lnsl -lm -lpthread -lrt

ifeq ($(DEBUG),1)
COMPILER_FLAGS += -g -O0
LINKER_FLAGS += -g
LIBS = -L$(NDDSHOME)/lib/$(TARGET_ARCH) \
        -lnddscppzd -lnddsczd -lnddscorezd $(SYSLIBS)
else
# This option strips the executable symbols
LINKER_FLAGS += -s
LIBS = -L$(NDDSHOME)/lib/$(TARGET_ARCH) \
        -lnddscppz -lnddscz -lnddscorez $(SYSLIBS)
endif

DEFINES = -DRTI_UNIX -DRTI_LINUX -DRTI_CONNEXT_DDS

INCLUDES = -I. -I$(NDDSHOME)/include -I$(NDDSHOME)/include/ndds

OBJDIR := objs/$(TARGET_ARCH)

EXEC          := $(executable_name)

$(OBJDIR)/$(EXEC) : objs/$(TARGET_ARCH) $(OBJDIR)/test_main.o
	$(LINKER) $(LINKER_FLAGS) -o $@ $(OBJDIR)/test_main.o $(LIBS)

$(OBJDIR)/%.o : %.cxx
	$(COMPILER) $(COMPILER_FLAGS) -Wextra -Wall -pedantic -o $@ $(DEFINES) $(INCLUDES) -c  $<

test_main.cxx : variant_rti_connext_dds.h

objs/$(TARGET_ARCH):
	echo "Making directory objs/$(TARGET_ARCH)";
	mkdir -p objs/$(TARGET_ARCH)
